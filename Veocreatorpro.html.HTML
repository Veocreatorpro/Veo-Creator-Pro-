<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veo Creator Pro com Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .pt-header { padding-top: 80px; }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root">
    <div class="min-h-screen flex items-center justify-center text-gray-800 text-2xl">
      A Carregar Aplica√ß√£o...
    </div>
  </div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const e = window.React.createElement;

    // --- CONFIGURA√á√ÉO DO SUPABASE ---
    const SUPABASE_URL = 'https://pngweulevcmmvhmqlbki.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBuZ3dldWxldmNtbXZobXFsYmtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzOTkyMzksImV4cCI6MjA2NDk3NTIzOX0.0Bb-JpSp1Zs3DyyR-1IZwiPYpLehe3Bv38eNU_wdnCg';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const formInputClass = "w-full p-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition shadow-sm";

    // --- COMPONENTES DA UI ---
    
    const Header = ({ user, profile, onLogout }) => {
      const displayName = (profile && profile.full_name) ? profile.full_name : (user ? user.email : "Convidado");
      const credits = (profile && profile.credits !== null) ? profile.credits : 0;

      return e('header', { className: "fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-b border-gray-200 p-4 z-40 flex justify-between items-center shadow-sm" },
        e('div', { className: "text-2xl font-bold text-purple-600" }, 'üé¨ Veo Creator Pro'),
        e('div', { className: "flex items-center gap-4" },
          user && profile
            ? e(window.React.Fragment, null,
                e('div', { className: 'bg-purple-100 text-purple-700 font-bold py-1 px-3 rounded-full text-sm' }, `${credits} cr√©ditos`),
                e('span', { className: "text-gray-600 hidden sm:inline" }, 'Ol√°, ', e('strong', { className: "font-semibold text-purple-600" }, displayName)),
                e('button', { onClick: onLogout, className: "bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md" }, 'Sair')
              )
            : e('span', { className: "text-gray-500" }, user ? "A carregar perfil..." : "A autenticar...")
        )
      );
    };
    
    const TabButton = ({ label, tabName, activeTab, setActiveTab }) => e('button', { onClick: () => setActiveTab(tabName), className: `py-2 px-6 font-semibold text-lg transition-colors duration-300 rounded-t-lg ${activeTab === tabName ? 'border-b-2 border-purple-500 text-purple-600 bg-gray-50' : 'text-gray-500 hover:text-purple-600 hover:bg-gray-50'}` }, label);
    
    const GuideContent = () => {
        const CheckIcon = () => e('svg', { className: "w-5 h-5 mr-2 text-green-500 shrink-0", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24", xmlns: "http://www.w3.org/2000/svg" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M5 13l4 4L19 7" }));
        return e('div', { className: "text-gray-700 p-4 max-h-[70vh] overflow-y-auto custom-scrollbar" },
            e('h1', { className: "text-3xl sm:text-4xl font-bold text-center mb-4 text-gray-800" }, 'Guia de Prompts'),
            e('p', { className: "text-center text-lg sm:text-xl mb-8 text-purple-600" }, 'Transforme Ideias em V√≠deos Incr√≠veis'),
            e('h2', { className: "text-2xl sm:text-3xl font-bold mb-4 text-gray-800" }, 'üí∞ Como Funcionam os Cr√©ditos'),
            e('ul', { className: "space-y-4 text-gray-600 text-base sm:text-lg mb-10" },
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', {className: "text-purple-600 font-semibold"}, "B√≥nus de Boas-Vindas: "), 'Todos os novos utilizadores recebem ', e('strong', null, '50 cr√©ditos gratuitos'), ' para come√ßar a criar imediatamente.')),
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', null, "Custo de Gera√ß√£o: "), 'Gerar um prompt para ', e('strong', null, 'uma cena custa 15 cr√©ditos'), '.')),
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', null, "Cenas Adicionais: "), 'Cada cena extra que adicionar ao mesmo pedido custa apenas ', e('strong', null, '5 cr√©ditos adicionais'), '.')),
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', null, "Exemplo: "), 'Um pedido com 3 cenas custar√° 15 (cena 1) + 5 (cena 2) + 5 (cena 3) = ', e('strong', null, '25 cr√©ditos'), '.')),
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', null, "Recarregar: "), 'Ficou sem cr√©ditos? Visite a aba ', e('strong', null, '"Comprar Cr√©ditos"'), ' para recarregar o seu saldo com um dos nossos pacotes.'))
            ),
            e('h2', { className: "text-2xl sm:text-3xl font-bold mb-4 text-gray-800" }, 'üîë Os 5 Pilares de um Prompt Perfeito'),
            e('ul', { className: "space-y-4 text-gray-600 text-base sm:text-lg" },
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', {className: "text-purple-600 font-semibold"}, "Sujeito (O Qu√™?): "), 'Seja espec√≠fico. Ex: ', e('em', {className: 'italic'}, 'um golden retriever filhote.'))),
                e('li', { className: "flex items-start" }, e(CheckIcon), e('span', null, e('strong', {className: "text-purple-600 font-semibold"}, "A√ß√£o (O Que Faz?): "), 'Descreva o movimento. Ex: ', e('em', {className: 'italic'}, 'correndo em c√¢mera lenta.')))
            )
        );
    };

    const GeneratorContent = (props) => {
        const {
          sujeito, setSujeito, cenario, setCenario, acao, setAcao,
          selectedEstiloVisual, setSelectedEstiloVisual, estiloVisualOptions,
          selectedCameras, setSelectedCameras, cameraOptions,
          selectedLighting, setSelectedLighting, lightingOptions,
          numScenes, setNumScenes,
          user, profile,
          isLoading, generateAndRefinePrompt,
          generatedScenes, copyToClipboard, handleMultiSelectChange
        } = props;
        
        const credits = profile?.credits ?? 0;
        const cost = 15 + (Math.max(0, numScenes - 1) * 5);
        const canAfford = credits >= cost;
        
        return e('div', { className: "p-1 md:p-4 max-h-[70vh] overflow-y-auto custom-scrollbar" },
            e('h2', { className: "text-2xl sm:text-3xl font-bold text-center mb-6 text-gray-800" }, 'Gerador de Prompt para Veo'),
              e('div', { className: "mb-4" }, e('label', { htmlFor: 'sujeitoTextarea', className: "block text-gray-700 font-semibold mb-2" }, 'Sujeito:'), e('textarea', { id: 'sujeitoTextarea', className: formInputClass, value: sujeito, onChange: (ev) => setSujeito(ev.target.value), rows: "2", placeholder: "Ex: um fusca azul-beb√™ de 1970" })),
              e('div', { className: "mb-4" }, e('label', { htmlFor: 'cenarioTextarea', className: "block text-gray-700 font-semibold mb-2" }, 'Cen√°rio:'), e('textarea', { id: 'cenarioTextarea', className: formInputClass, value: cenario, onChange: (ev) => setCenario(ev.target.value), rows: "2", placeholder: "Ex: numa estrada costeira ao p√¥r do sol" })),
              e('div', { className: "mb-4" }, e('label', { htmlFor: 'acaoTextarea', className: "block text-gray-700 font-semibold mb-2" }, 'A√ß√£o:'), e('textarea', { id: 'acaoTextarea', className: formInputClass, value: acao, onChange: (ev) => setAcao(ev.target.value), rows: "2", placeholder: "Ex: correndo em c√¢mera lenta" })),
              e('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" },
                e('div', null, e('label', { htmlFor: 'estiloVisualSelect', className: "block text-gray-700 font-semibold mb-2" }, 'Estilo Visual:'), e('select', { id: 'estiloVisualSelect', multiple: true, className: `${formInputClass} h-32`, value: selectedEstiloVisual, onChange: (ev) => handleMultiSelectChange(ev, setSelectedEstiloVisual) }, estiloVisualOptions.map(o => e('option', { key: o, value: o }, o)))),
                e('div', null, e('label', { htmlFor: 'cameraSelect', className: "block text-gray-700 font-semibold mb-2" }, 'C√¢mera:'), e('select', { id: 'cameraSelect', multiple: true, className: `${formInputClass} h-32`, value: selectedCameras, onChange: (ev) => handleMultiSelectChange(ev, setSelectedCameras) }, cameraOptions.map(o => e('option', { key: o, value: o }, o))))
            ),
              e('div', { className: "mb-4" }, e('label', { htmlFor: 'lightingSelect', className: "block text-gray-700 font-semibold mb-2" }, 'Ilumina√ß√£o:'), e('select', { id: 'lightingSelect', multiple: true, className: `${formInputClass} h-32`, value: selectedLighting, onChange: (ev) => handleMultiSelectChange(ev, setSelectedLighting) }, lightingOptions.map(o => e('option', { key: o, value: o }, o)))),
            e('div', { className: "mb-4" }, e('label', { htmlFor: 'numScenes', className: "block text-gray-700 font-semibold mb-2" }, 'Qtd. de Cenas:'), e('input', { type: 'number', id: 'numScenes', className: formInputClass, value: numScenes, onChange: (ev) => setNumScenes(Math.max(1, parseInt(ev.target.value, 10) || 1)), min: "1" })),
            e('div', { className: "text-center mt-4 mb-4 text-gray-600 text-lg font-medium h-6" }, user && e('span', null, `Voc√™ tem ${credits} cr√©dito(s).`)),
            e('button', { onClick: () => generateAndRefinePrompt(cost), className: `w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed`, disabled: isLoading || !canAfford }, isLoading ? 'A gerar...' : `Gerar Prompts (Custo: ${cost} ${cost > 1 ? 'cr√©ditos' : 'cr√©dito'})`),
            e('div', { className: "mt-8" }, e('h3', { className: "text-xl font-bold mb-3 text-gray-800" }, 'Prompts Gerados:'),
              generatedScenes.length > 0
                ? generatedScenes.map((prompt, index) => e('div', { key: index, className: "mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm" }, e('textarea', { readOnly: true, className: "w-full h-28 p-2 bg-transparent text-gray-800 resize-y", value: prompt }), e('button', { onClick: () => copyToClipboard(prompt), className: "mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300" }, 'Copiar Prompt')))
                : e('textarea', { readOnly: true, className: "w-full h-32 p-4 bg-gray-50 text-gray-500 rounded-lg border border-gray-200 shadow-sm", value: "Os seus prompts de cena aparecer√£o aqui..." })
            )
        );
    };

    const BuyCreditsContent = ({ onBuyCredits }) => {
        const creditPacks = [
            { amount: 50, price: 19.99 }, 
            { amount: 75, price: 29.99 },
            { amount: 100, price: 39.99 }, 
            { amount: 125, price: 48.75 }, 
            { amount: 150, price: 58.50 }
        ];

        const CreditPackCard = ({ pack, onBuy }) => e('div', { className: "border border-gray-300 rounded-2xl p-6 flex flex-col items-center text-center transition-transform transform hover:scale-105 shadow-md bg-white" }, 
            e('p', { className: "text-4xl font-bold text-purple-600" }, pack.amount), 
            e('p', { className: "text-lg font-semibold text-gray-800 mb-4" }, "Cr√©ditos"), 
            e('p', { className: "text-xl font-bold text-gray-900 mb-6" }, `R$ ${pack.price.toFixed(2).replace('.', ',')}`), 
            e('button', { onClick: () => onBuy(pack), className: "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300" }, "Comprar")
        );
        
        const FreePlanCard = () => {
            const CheckIcon = () => e('svg', { className: "w-5 h-5 mr-2 text-green-500 shrink-0", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24", xmlns: "http://www.w3.org/2000/svg" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M5 13l4 4L19 7" }));
            return e('div', { className: "border-2 border-purple-500 rounded-2xl p-8 flex flex-col shadow-lg bg-white" }, 
                e('h3', { className: "text-2xl font-bold text-center text-gray-800 mb-2" }, "Plano Gratuito"), 
                e('p', { className: "text-center text-gray-500 mb-6" }, 'Para experimentar a plataforma.'), 
                e('ul', { className: "space-y-4 text-gray-600 mb-8 flex-grow" }, 
                    e('li', { className: "flex items-center" }, e(CheckIcon), "50 cr√©ditos iniciais para come√ßar"), 
                    e('li', { className: "flex items-center" }, e(CheckIcon), "Acesso a todos os campos de gera√ß√£o"), 
                    e('li', { className: "flex items-center" }, e(CheckIcon), "Suporte da comunidade")
                ), 
                e('button', { disabled: true, className: `w-full font-bold py-3 px-6 rounded-xl shadow-lg bg-gray-300 text-gray-600 cursor-not-allowed`}, 'O seu Plano Atual')
            );
        };

        return e('div', { className: "p-4 max-h-[70vh] overflow-y-auto custom-scrollbar" },
            e('h1', { className: "text-3xl sm:text-4xl font-bold text-center mb-12 text-gray-800" }, 'Planos e Cr√©ditos'),
            e('div', { className: "max-w-md mx-auto mb-16" }, e(FreePlanCard)),
            e('div', {className: 'text-center'}, e('h2', { className: "text-2xl sm:text-3xl font-bold text-center mb-4 text-gray-800" }, 'Precisa de mais?'), e('p', { className: "text-center text-lg sm:text-xl mb-12 text-gray-600" }, 'Recarregue o seu saldo para continuar a criar.')),
            e('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto" },
                creditPacks.map(pack => e(CreditPackCard, { key: pack.amount, pack, onBuy: onBuyCredits }))
            )
        );
    };

    const AuthContent = ({ onLogin, onSignUp, isLoading }) => {
        const [isSignUp, setIsSignUp] = window.React.useState(false);
        const [email, setEmail] = window.React.useState('');
        const [password, setPassword] = window.React.useState('');
        const [fullName, setFullName] = window.React.useState('');
        const [birthDate, setBirthDate] = window.React.useState('');
        const [cpf, setCpf] = window.React.useState('');

        const handleSubmit = (e) => {
            e.preventDefault();
            if (isSignUp) {
                onSignUp({ email, password, fullName, birthDate, cpf });
            } else {
                onLogin(email, password);
            }
        };

        const signupForm = e('div', null,
            e('div', { className: 'mb-4' },
                e('label', { htmlFor: 'fullName', className: 'block text-gray-700 font-semibold mb-2' }, 'Nome Completo'),
                e('input', { type: 'text', id: 'fullName', value: fullName, onChange: ev => setFullName(ev.target.value), className: formInputClass, required: true })
            ),
            e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-4' },
                e('div', null,
                  e('label', { htmlFor: 'birthDate', className: 'block text-gray-700 font-semibold mb-2' }, 'Data de Nascimento'),
                  e('input', { type: 'date', id: 'birthDate', value: birthDate, onChange: ev => setBirthDate(ev.target.value), className: formInputClass, required: false })
                ),
                e('div', null,
                  e('label', { htmlFor: 'cpf', className: 'block text-gray-700 font-semibold mb-2' }, 'CPF'),
                  e('input', { type: 'text', id: 'cpf', value: cpf, onChange: ev => setCpf(ev.target.value), className: formInputClass, placeholder: '000.000.000-00', required: true })
                )
            )
        );

        return e('div', { className: 'min-h-screen flex flex-col items-center justify-center p-4 bg-gray-50' },
            e('div', { className: 'w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-gray-200' },
                e('h2', { className: 'text-3xl font-bold text-center text-gray-800 mb-2' }, 'üé¨ Veo Creator Pro'),
                e('p', { className: 'text-center text-gray-500 mb-8' }, isSignUp ? 'Crie a sua conta para come√ßar' : 'Aceda √† sua conta'),
                e('form', { onSubmit: handleSubmit },
                    e('div', { className: 'mb-4' },
                        e('label', { htmlFor: 'email', className: 'block text-gray-700 font-semibold mb-2' }, 'Email'),
                        e('input', { type: 'email', id: 'email', value: email, onChange: ev => setEmail(ev.target.value), className: formInputClass, placeholder: 'seu@email.com', required: true })
                    ),
                    isSignUp && signupForm,
                    e('div', { className: 'mb-6' },
                        e('label', { htmlFor: 'password', className: 'block text-gray-700 font-semibold mb-2' }, 'Senha'),
                        e('input', { type: 'password', id: 'password', value: password, onChange: ev => setPassword(ev.target.value), className: formInputClass, placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢', required: true })
                    ),
                    e('button', { type: 'submit', disabled: isLoading, className: 'w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md disabled:bg-gray-400' }, 
                        isLoading ? 'A processar...' : (isSignUp ? 'Criar Conta' : 'Entrar')),
                    e('p', { className: 'text-center text-gray-600 mt-6' },
                        isSignUp ? 'J√° tem uma conta? ' : 'N√£o tem uma conta? ',
                        e('button', { type: 'button', onClick: () => setIsSignUp(!isSignUp), className: 'font-semibold text-purple-600 hover:text-purple-800' }, isSignUp ? 'Fa√ßa o Login' : 'Registe-se')
                    )
                )
            )
        );
    };

    // --- COMPONENTE PRINCIPAL DA APLICA√á√ÉO ---
    function App() {
      const [session, setSession] = window.React.useState(null);
      const [profile, setProfile] = window.React.useState(null);
      const [isLoading, setIsLoading] = window.React.useState(true);
      const [appError, setAppError] = window.React.useState(null);
      const [activeTab, setActiveTab] = window.React.useState('generator');
      const [uiMessage, setUiMessage] = window.React.useState({ text: '', type: '' });

      const [sujeito, setSujeito] = window.React.useState('');
      const [acao, setAcao] = window.React.useState('');
      const [cenario, setCenario] = window.React.useState('');
      const [selectedEstiloVisual, setSelectedEstiloVisual] = window.React.useState([]);
      const [selectedCameras, setSelectedCameras] = window.React.useState([]);
      const [selectedLighting, setSelectedLighting] = window.React.useState([]);
      const [numScenes, setNumScenes] = window.React.useState(1);
      const [generatedScenes, setGeneratedScenes] = window.React.useState([]);
      
      const estiloVisualOptions = ['Cinem√°tico', 'Fotorealista (8K)', 'Anime', 'Aquarela', '3D', 'Vintage', 'Cyberpunk', 'Preto e branco'];
      const cameraOptions = ['Close-up', 'Plano geral', 'Vista a√©rea', 'Panor√¢mica', 'C√¢mera lenta'];
      const lightingOptions = ['Luz natural', 'Ilumina√ß√£o dram√°tica', 'Luz suave', 'Neon', 'P√¥r do sol'];
      
      // Hook de Efeito para Autentica√ß√£o e Perfil
      window.React.useEffect(() => {
        // Fun√ß√£o para buscar e configurar o perfil do utilizador
        const getProfile = async (user) => {
          setIsLoading(true);
          setProfile(null);
          try {
            let { data: userProfile, error: profileError } = await supabase
              .from('profiles')
              .select('*')
              .eq('id', user.id)
              .single();

            if (profileError && profileError.code !== 'PGRST116') {
              throw new Error(`Erro ao procurar o perfil: ${profileError.message}`);
            }
            
            if (!userProfile) {
              console.log("Perfil n√£o encontrado, a criar um novo...");
              const { data: newUserProfile, error: createError } = await supabase
                .from('profiles')
                .insert([{ id: user.id, email: user.email, full_name: user.email, credits: 50 }])
                .select()
                .single();
              
              if (createError) throw new Error(`Erro ao criar o perfil: ${createError.message}`);
              userProfile = newUserProfile;
              setUiMessage({ text: 'Bem-vindo! Adicion√°mos 50 cr√©ditos √† sua conta.', type: 'info'});
            }
            setProfile(userProfile);
          } catch (error) {
            console.error("Erro cr√≠tico no processo de autentica√ß√£o:", error.message);
            setAppError(`Ocorreu um problema ao configurar a sua conta. Por favor, tente fazer login novamente. Detalhes: ${error.message}`);
            await supabase.auth.signOut();
          } finally {
            setIsLoading(false);
          }
        };

        // Verifica a sess√£o inicial quando a aplica√ß√£o carrega
        supabase.auth.getSession().then(({ data: { session } }) => {
          setSession(session);
          if (session?.user) {
            getProfile(session.user);
          } else {
            setIsLoading(false);
          }
        });

        // Ouve mudan√ßas no estado de autentica√ß√£o (login, logout)
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          setSession(session);
          if (session?.user) {
            // Apenas busca o perfil se ele ainda n√£o estiver carregado, para evitar chamadas duplicadas
            if (!profile) {
                 getProfile(session.user);
            }
          } else {
            setProfile(null);
            setIsLoading(false);
          }
        });

        return () => subscription?.unsubscribe();
      }, []); // Depend√™ncia vazia para executar apenas uma vez na montagem

      window.React.useEffect(() => {
        if (uiMessage.text) {
          const timer = setTimeout(() => setUiMessage({ text: '', type: '' }), 5000);
          return () => clearTimeout(timer);
        }
      }, [uiMessage]);

      const handleSignUp = async (formData) => {
        setIsLoading(true);
        const { data, error } = await supabase.functions.invoke('custom-signup', { body: formData });
        if (error || data.error) {
            setUiMessage({ text: data?.error || error.message, type: 'error' });
        } else {
            setUiMessage({ text: "Conta criada! Por favor, fa√ßa o login para continuar.", type: 'info' });
        }
        setIsLoading(false);
      };

      const handleLogin = async (email, password) => {
        setIsLoading(true);
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          setUiMessage({ text: 'Email ou senha inv√°lidos.', type: 'error' });
          setIsLoading(false);
        }
      };

      const handleLogout = async () => {
        setIsLoading(true);
        await supabase.auth.signOut();
      };
      
      const handleBuyCredits = async (pack) => {
        if (!session?.user || !profile) {
            setUiMessage({ text: "Precisa de estar autenticado para comprar cr√©ditos.", type: "error"});
            return;
        }
        setIsLoading(true);
        try {
          const { data, error } = await supabase.functions.invoke('create-pagbank-order', {
              body: { 
                  pack,
                  user: { id: session.user.id, email: session.user.email, profile }
              } 
          });
          if (error || data.error) throw new Error(data?.error || error.message);
          
          if (data?.paymentLink) {
              window.open(data.paymentLink, '_blank');
              setTimeout(() => {
                  setIsLoading(false);
                  setUiMessage({ text: "A sua janela de pagamento foi aberta.", type: 'info' });
              }, 1500);
          } else {
            setIsLoading(false);
          }

        } catch (error) {
          // Log do erro t√©cnico para depura√ß√£o
          console.error("Erro ao invocar a Edge Function 'create-pagbank-order':", error);
          // Mensagem amig√°vel para o utilizador
          setUiMessage({ text: "Erro ao processar o pagamento. O servidor n√£o respondeu como esperado. Por favor, tente novamente mais tarde.", type: "error"});
          setIsLoading(false);
        }
      };
      
      const handleMultiSelectChange = (e, setter) => setter(Array.from(e.target.selectedOptions, option => option.value));

      const copyToClipboard = (text) => {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.top = "-9999px";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.select();
          try {
              document.execCommand('copy');
              setUiMessage({ text: 'Prompt copiado!', type: 'info' });
          } catch (err) {
              console.error('Falha ao copiar: ', err);
              setUiMessage({ text: 'Falha ao copiar.', type: 'error' });
          }
          document.body.removeChild(textArea);
      };
      
      const generateAndRefinePrompt = async (cost) => {
        if (!session?.user || !profile || (profile.credits < cost)) {
            setUiMessage({ text: 'Cr√©ditos insuficientes ou erro de autentica√ß√£o.', type: 'error' }); 
            return; 
        }
        const basePromptText = [sujeito, cenario, acao, ...selectedEstiloVisual, ...selectedCameras, ...selectedLighting].filter(Boolean).join(', ');
        if (!basePromptText.trim()) { 
          setUiMessage({ text: 'Por favor, preencha pelo menos um campo.', type: 'error' }); 
          return; 
        }
        setIsLoading(true);
        try {
            const { data, error } = await supabase.functions.invoke('generate-veo-prompts', {
                body: { basePrompt: basePromptText, numScenes, userId: session.user.id },
            });
            if (error || data.error) throw new Error(data?.error || error.message);
            if (data?.scenes) {
                setGeneratedScenes(data.scenes);
                const newCreditBalance = profile.credits - cost;
                const { error: updateError } = await supabase.from('profiles').update({ credits: newCreditBalance }).eq('id', session.user.id);
                if (updateError) throw updateError;
                setProfile(prev => ({ ...prev, credits: newCreditBalance }));
                setUiMessage({ text: 'Prompts gerados com sucesso!', type: 'info' });
            }
        } catch (error) { 
          setUiMessage({ text: `Erro ao gerar prompts: ${error.message}.`, type: 'error' }); 
        } finally { 
          setIsLoading(false);
        }
      };
      
      const loadingOverlay = isLoading && e('div', { className: "fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" },
          e('div', { className: "flex flex-col items-center text-white" },
            e('svg', { className: "animate-spin h-10 w-10 text-white mb-4", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
              e('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
              e('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
            ),
            e('p', { className: "text-xl" }, uiMessage.text || 'A processar...')
          )
        );

      const messagePopup = uiMessage.text && !isLoading && e('div', { 
            className: `fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-white z-50 transition-opacity duration-300 ${uiMessage.type === 'error' ? 'bg-red-600' : 'bg-green-600'}` 
          }, uiMessage.text);

      if (isLoading && !session && !appError) {
        return e('div', { className: "min-h-screen flex items-center justify-center text-gray-800 text-2xl" }, 'A Carregar Aplica√ß√£o...');
      }

      if (appError) {
        return e('div', { className: "min-h-screen flex flex-col items-center justify-center p-8 bg-red-50 text-red-700" },
          e('h2', { className: "text-2xl font-bold mb-4" }, "Ocorreu um Erro Cr√≠tico"),
          e('p', { className: "text-center" }, appError),
          e('button', { onClick: () => { setAppError(null); setIsLoading(true); supabase.auth.signOut(); }, className: "mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded" }, "Tentar Novamente")
        );
      }
      
      if (!session?.user) {
        return e(window.React.Fragment, null,
          loadingOverlay,
          e(AuthContent, { onLogin: handleLogin, onSignUp: handleSignUp, isLoading }),
          messagePopup
        );
      }
      
      if (!profile) {
          return e(window.React.Fragment, null,
              loadingOverlay,
              e(Header, { user: session.user, profile: null, onLogout: handleLogout }),
              e('div', { className: "min-h-screen flex items-center justify-center text-gray-800 text-2xl" }, 'A carregar dados do utilizador...')
          );
      }
      
      const generatorProps = {
          sujeito, setSujeito, cenario, setCenario, acao, setAcao,
          selectedEstiloVisual, setSelectedEstiloVisual, estiloVisualOptions,
          selectedCameras, setSelectedCameras, cameraOptions,
          selectedLighting, setSelectedLighting, lightingOptions,
          numScenes, setNumScenes,
          user: session.user, profile,
          isLoading, generateAndRefinePrompt,
          generatedScenes, copyToClipboard, handleMultiSelectChange
      };
      
      return e(window.React.Fragment, null,
        loadingOverlay,
        e(Header, { user: session.user, profile, onLogout: handleLogout }),
        e('main', { className: "min-h-screen text-gray-800 p-4 sm:p-6 lg:p-8 flex flex-col items-center pt-header" },
            e('div', { className: "w-full max-w-5xl bg-white rounded-2xl shadow-xl p-4 sm:p-8 border border-gray-200" },
              e('div', { className: "flex border-b border-gray-200 mb-6 justify-center" },
                e(TabButton, { label: "Gerador", tabName: "generator", activeTab, setActiveTab }),
                e(TabButton, { label: "Comprar Cr√©ditos", tabName: "credits", activeTab, setActiveTab }),
                e(TabButton, { label: "Guia", tabName: "guide", activeTab, setActiveTab })
              ),
              e('div', null,
                activeTab === 'generator' && e(GeneratorContent, generatorProps),
                activeTab === 'credits' && e(BuyCreditsContent, { onBuyCredits: handleBuyCredits }),
                activeTab === 'guide' && e(GuideContent)
              )
            )
        ),
        messagePopup
      );
    }
    
    const root = window.ReactDOM.createRoot(document.getElementById('root'));
    root.render(e(App));
  </script>
</body>
</html>
